#!/usr/bin/env bash
# Install onmsg using homebrew

set -o pipefail
set -e

# Install a local homebrew if not already done
HOMEBREW="$HOME"/brew
if ! [ -d ~/brew ] ; then
    cd ~
    git clone https://github.com/Homebrew/homebrew "$HOMEBREW"
fi

export PATH="$HOMEBREW"/bin:"$PATH"

export COLUMNS=80 # for pip, which seems to need this.

# find the User's python library location
USER_SITE_PACKAGES="$(easy_install -n --user python | grep install_dir | sed -e 's/install_dir //')"
USER_PYTHON_EXECUTABLES="$USER_SITE_PACKAGES/../../.."/bin
export PATH="$USER_PYTHON_EXECUTABLES:$PATH"

# Get an up-to-date pip
if ! [ "$(which pip)" ] ; then
    easy_install --user pip
else
    pip install --upgrade --user --install-option="--prefix=" pip
fi

# Use it to get an up-to-date imaplib2
IMAPLIB2_HEAD=a205409a0047732840505e534c07d8d85d2644a1
CELLAR_PREFIX=$(brew --cellar)/onmsg-imaplib2/git-$IMAPLIB2_HEAD
if [ -d $(brew --cellar)/onmsg-imaplib2 ] ; then
    brew rm onmsg-imaplib2
fi
BUILD=$(mktemp -d)
pip install --upgrade \
    --build="$BUILD" \
    --install-option="--prefix=$CELLAR_PREFIX" \
    --install-option="--install-scripts=$CELLAR_PREFIX/share/python" \
    https://sourceforge.net/code-snapshots/git/i/im/imaplib2/code.git/imaplib2-code-${IMAPLIB2_HEAD}.zip
brew link onmsg-imaplib2
rmdir "$BUILD"

# Install stunnel, so leafnode can access gmane inside Apple's firewall
brew install stunnel

brew install dovecot --with-clucene --with-stemmer
brew install leafnode
brew install isync
mkdir -p "$HOME"/Library/Data/mbsync

# Create a disk image and mount point for leafnode's news spool.  Last
# we checked, its ordinary format soaks up way too many actual inodes.
LEAFNODE_IMAGE="$HOME"/Library/Data/leafnode.sparsebundle
LEAFNODE_DIR="$HOME"/Library/Data/leafnode
if ! [ -e "$LEAFNODE_IMAGE" ]; then
    hdiutil create -size 10g "$LEAFNODE_IMAGE" -fs "JHFS+X" -uid 99 -gid 99
fi
hdiutil attach "$LEAFNODE_IMAGE" -mountpoint "$LEAFNODE_DIR" -nobrowse -noautofsck

# Get an up-to-date emacs
brew tap railwaycat/emacsmacport
brew cask install emacs-mac
brew upgrade emacs-mac
brew linkapps


